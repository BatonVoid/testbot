import asyncio
import random
import logging
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, Router, F
from aiogram.enums import ParseMode
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.filters import Command, CommandStart
from sqlalchemy import create_engine, Column, Integer, String, BigInteger, Boolean, JSON
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from aiogram.client.default import DefaultBotProperties
from aiogram.exceptions import TelegramForbiddenError

# Настройки
TOKEN = "7909566566:AAEPuzHlvuME-WTOaL7jbGB_FHHCFtfG40Q"
TEST_START = datetime(2025, 5, 31, 0, 0)   # 1 мая, 00:00
TEST_END   = datetime(2025, 5, 31, 23, 59, 59)  # 1 мая, 23:59:59

logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# Telegram
bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())
router = Router()
dp.include_router(router)

# База данных
Base = declarative_base()
engine = create_engine("sqlite:///test.db")
Session = sessionmaker(bind=engine)

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    telegram_id = Column(BigInteger, unique=True)
    full_name = Column(String)
    score = Column(Integer, default=0)
    completed = Column(Boolean, default=False)
    estimated_duration = Column(Integer)  # в секундах

class Question(Base):
    __tablename__ = "questions"
    id = Column(Integer, primary_key=True)
    text = Column(String)
    options = Column(JSON)
    correct_option = Column(String)
Base.metadata.create_all(engine)

sample_questions = [
                    {
                        "text": "Лидерлар китоби'нинг асосий мақсади нима?",
                        "options": ["Бизнес стратегияларини ўргатиш", "Шахсий ривожланиш ва лидерлик кўникмаларини шакллантириш", "Молиявий саводхонликни ошириш"],
                        "correct": "Шахсий ривожланиш ва лидерлик кўникмаларини шакллантириш"
                    },
                    {
                        "text": "Китобда лидерликнинг қайси жиҳатларига кўпроқ эътибор қаратилади?",
                        "options": ["Технологик инновациялар", "Сиёсий бошқарув", "Шахсий фазилатлар ва жамоани бошқариш"],
                        "correct": "Шахсий фазилатлар ва жамоани бошқариш"
                    },
                    {
                        "text": "Отабек Ҳасанов лидерликни қандай таърифлайди?",
                        "options": ["Бошқаларни мажбурлаш орқали эргаштириш", "Ўзгаришларга илҳомлантириш ва таъсир кўрсатиш жараёни", "Фақатгина буйруқ бериш ва назорат қилиш"],
                        "correct": "Ўзгаришларга илҳомлантириш ва таъсир кўрсатиш жараёни"
                    },
                    {
                        "text": "Лидернинг муҳим фазилатларидан бирини кўрсатинг.",
                        "options": ["Қатъиятсизлик", "Эмпатия", "Ўзига ишончсизлик"],
                        "correct": "Эмпатия"
                    },
                    {
                        "text": "Китобда қайси мавзуга алоҳида урғу берилади?",
                        "options": ["Маркетинг ва сотувлар", "Коммуникация ва таъсир ўтказиш", "Лойиҳа бошқаруви"],
                        "correct": "Коммуникация ва таъсир ўтказиш"
                    },
                    {
                        "text": "Лидер жамоа аъзоларига қандай муносабатда бўлиши керак?",
                        "options": ["Фақат топшириқ бериб, назорат қилиши керак", "Уларни қўллаб-қувватлаши, рағбатлантириши ва ривожланишига ёрдам бериши керак", "Уларнинг шахсий ҳаётига аралашиб, дўстона муносабатда бўлиши керак"],
                        "correct": "Уларни қўллаб-қувватлаши, рағбатлантириши ва ривожланишига ёрдам бериши керак"
                    },
                    {
                        "text": "Лидерликда визиянинг аҳамияти нимада?",
                        "options": ["Жамоани тартибга солиш учун", "Келажакни аниқ тасаввур қилиш ва жамоани шу йўлда бирлаштириш учун", "Рақобатчилардан устун келиш учун"],
                        "correct": "Келажакни аниқ тасаввур қилиш ва жамоани шу йўлда бирлаштириш учун"
                    },
                    {
                        "text": "Китобда лидер учун зарур деб таъкидланган кўникмалардан бири:",
                        "options": ["Фақат техник кўникмалар", "Вақтни самарали бошқариш", "Молиявий таҳлил"],
                        "correct": "Вақтни самарали бошқариш"
                    },
                    {
                        "text": "Лидерликда муваффақиятга эришишнинг асосий шарти нима?",
                        "options": ["Доимо ҳақ бўлиш", "Ўз хатоларини тан олиш ва улардан сабоқ чиқариш", "Бошқаларни айблаш"],
                        "correct": "Ўз хатоларини тан олиш ва улардан сабоқ чиқариш"
                    },
                    {
                        "text": "Китобда лидерликнинг қайси томонига эътибор қаратилмайди?",
                        "options": ["Ахлоқий меъёрлар", "Шахсий манфаатларни жамоа манфаатидан устун қўйиш", "Жамоа манфаатлари"],
                        "correct": "Шахсий манфаатларни жамоа манфаатидан устун қўйиш"
                    },
                    {
                        "text": "Лидер қандай қарорлар қабул қилиши керак?",
                        "options": ["Фақат ўзининг фикрига асосланиб", "Жамоа фикрини инобатга олиб, адолатли ва мақсадга мувофиқ", "Энг тез ва осон йўлни танлаб"],
                        "correct": "Жамоа фикрини инобатга олиб, адолатли ва мақсадга мувофиқ"
                    },
                    {
                        "text": "Лидерликда мотивациянинг ўрни қандай?",
                        "options": ["Мотивациянинг аҳамияти йўқ", "Жамоа аъзоларининг ички иштиёқини уйғотиш ва уларни мақсадга етишишга ундаш", "Фақат моддий рағбатлантириш орқали эришилади"],
                        "correct": "Жамоа аъзоларининг ички иштиёқини уйғотиш ва уларни мақсадга етишишга ундаш"
                    },
                    {
                        "text": "Китобда лидернинг қайси масъулияти таъкидланади?",
                        "options": ["Фақат ташкилотнинг фойдаси учун жавобгарлик", "Жамоа аъзоларининг фаровонлиги ва ривожланиши учун жавобгарлик", "Фақат ўз карьераси учун жавобгарлик"],
                        "correct": "Жамоа аъзоларининг фаровонлиги ва ривожланиши учун жавобгарлик"
                    },
                    {
                        "text": "Лидерликда ишончнинг аҳамияти нимада?",
                        "options": ["Ишончнинг аҳамияти кам", "Жамоа аъзолари ўртасидаги ҳамкорлик ва садоқатни мустаҳкамлаш учун", "Фақат лидернинг ўзига бўлган ишончи муҳим"],
                        "correct": "Жамоа аъзолари ўртасидаги ҳамкорлик ва садоқатни мустаҳкамлаш учун"
                    },
                    {
                        "text": "Китобда ўзгаришларга муносабат қандай бўлиши кераклиги таъкидланади?",
                        "options": ["Ўзгаришларга қарши туриш керак", "Ўзгаришларни қабул қилиш ва уларга мослашиш керак", "Ўзгаришларни эътиборсиз қолдириш керак"],
                        "correct": "Ўзгаришларни қабул қилиш ва уларга мослашиш керак"
                    },
                    {
                        "text": "Лидерликда ўрганиш ва ривожланишнинг аҳамияти нимада?",
                        "options": ["Лидер доимо билимдон бўлиши керак", "Замон билан ҳамнафас бўлиш, янги билим ва кўникмаларни эгаллаш", "Ўрганиш ва ривожланишнинг аҳамияти йўқ"],
                        "correct": "Замон билан ҳамнафас бўлиш, янги билим ва кўникмаларни эгаллаш"
                    },
                    {
                        "text": "Китобда лидернинг қайси муносабати танқид қилинади?",
                        "options": ["Очиқлик ва шаффофлик", "Манманлик ва такаббурлик", "Камтарлик ва холислик"],
                        "correct": "Манманлик ва такаббурлик"
                    },
                    {
                        "text": "Лидерликда эшитиш қобилиятининг аҳамияти нимада?",
                        "options": ["Фақат ўз фикрини билдириш муҳим", "Жамоа аъзоларининг фикрларини эшитиш ва уларни инобатга олиш", "Эшитиш қобилиятининг аҳамияти кам"],
                        "correct": "Жамоа аъзоларининг фикрларини эшитиш ва уларни инобатга олиш"
                    },
                    {
                        "text": "Китобда қадриятларнинг ўрни қандай белгиланади?",
                        "options": ["Қадриятларнинг аҳамияти йўқ", "Лидер ва жамоа фаолиятининг асоси бўлиши керак", "Қадриятлар фақат расмий ҳужжатларда бўлиши керак"],
                        "correct": "Лидер ва жамоа фаолиятининг асоси бўлиши керак"
                    },
                    {
                        "text": "Лидер қандай муаммоларни ҳал қилиши керак?",
                        "options": ["Фақат осон муаммоларни", "Мураккаб, стратегик ва жамоа учун муҳим бўлган муаммоларни", "Муаммоларни эътиборсиз қолдириш"],
                        "correct": "Мураккаб, стратегик ва жамоа учун муҳим бўлган муаммоларни"
                    },
                    {
                        "text": "Китобда лидернинг қайси хислати рағбатлантирилади?",
                        "options": ["Қўрқоқлик", "Таваккал қилишга тайёрлик", "Консервативлик"],
                        "correct": "Таваккал қилишга тайёрлик"
                    },
                    {
                        "text": "Лидерликда мақсад қўйишнинг аҳамияти нимада?",
                        "options": ["Мақсадсиз фаолият самарали бўлади", "Аниқ мақсад жамоани бирлаштиради ва ҳаракатни йўналтиради", "Мақсад қўйиш вақтни беҳуда сарфлашдир"],
                        "correct": "Аниқ мақсад жамоани бирлаштиради ва ҳаракатни йўналтиради"
                    },
                    {
                        "text": "'Лидерлар китоби'да қайси усул лидерликни ривожлантириш учун тавсия этилмайди?",
                        "options": ["Ўз-ўзини таҳлил қилиш", "Мураббий билан ишлаш", "Фақат назарий билимларни ўрганиш ва амалиётга татбиқ этмаслик"],
                        "correct": "Фақат назарий билимларни ўрганиш ва амалиётга татбиқ этмаслик"
                    },
                    {
                        "text": "Лидерликда фикр-мулоҳаза (feedback) нинг аҳамияти нимада?",
                        "options": ["Фикр-мулоҳазанинг аҳамияти йўқ", "Ўз фаолиятини баҳолаш ва яхшилаш учун", "Бошқаларни танқид қилиш учун"],
                        "correct": "Ўз фаолиятини баҳолаш ва яхшилаш учун"
                    },
                    {
                        "text": "Китобда лидернинг қайси муносабати жамоага зарар келтириши мумкин?",
                        "options": ["Адолатлилик", "Субъективлик ва ғаразгўйлик", "Холислик"],
                        "correct": "Субъективлик ва ғаразгўйлик"
                    },
                    {
                        "text": "Лидерликда ваколатларни топшириш (delegation) нинг аҳамияти нимада?",
                        "options": ["Лидер барча ишни ўзи қилиши керак", "Жамоа аъзоларининг масъулиятини ошириш ва иш самарадорлигини кўтариш", "Ваколатларни топшириш лидернинг обрўсини туширади"],
                        "correct": "Жамоа аъзоларининг масъулиятини ошириш ва иш самарадорлигини кўтариш"
                    },
                    {
                        "text": "'Лидерлар китоби'да стратегиянинг ўрни қандай белгиланади?",
                        "options": ["Стратегиянинг аҳамияти кам", "Узоқ муддатли мақсадларга эришишнинг асосий йўли", "Фақат тактик ҳаракатлар муҳим"],
                        "correct": "Узоқ муддатли мақсадларга эришишнинг асосий йўли"
                    },
                    {
                        "text": "Лидерликда мулоқотнинг қайси тури самарали ҳисобланади?",
                        "options": ["Фақат бир томонлама", "Очиқ, икки томонлама ва эмпатияга асосланган", "Расмий ва қуруқ"],
                        "correct": "Очиқ, икки томонлама ва эмпатияга асосланган"
                    },
                    {
                        "text": "Китобда лидернинг қайси сифати жамоада норозилик келтириб чиқариши мумкин?",
                        "options": ["Ҳурмат", "Менсимаслик", "Эътиборлилик"],
                        "correct": "Менсимаслик"
                    },
                    {
                        "text": "Лидерликда интуициянинг ўрни қандай?",
                        "options": ["Интуицияга таяниш хавфли", "Тажриба ва билимлар билан бирга муҳим қарорлар қабул қилишда ёрдам бериши мумкин", "Фақат мантиққа асосланиш керак"],
                        "correct": "Тажриба ва билимлар билан бирга муҳим қарорлар қабул қилишда ёрдам бериши мумкин"
                    },
                    {
                        "text": "'Лидерлар китоби'да инновацияларнинг аҳамияти қандай таърифланади?",
                        "options": ["Инновацияларнинг аҳамияти йўқ", "Рақобатбардошликни таъминлаш ва ривожланишнинг асосий манбаи", "Инновациялар фақат катта компаниялар учун зарур"],
                        "correct": "Рақобатбардошликни таъминлаш ва ривожланишнинг асосий манбаи"
                    },
                    {
                        "text": "Лидер қандай қилиб самарали жамоа тузиши мумкин?",
                        "options": ["Фақат ўзига ўхшаган одамларни йиғиш орқали", "Турли хил кўникма ва нуқтаи назарларга эга бўлган аъзоларни жалб қилиш орқали", "Жамоа аъзоларининг шахсий хусусиятларига эътибор бермаслик орқали"],
                        "correct": "Турли хил кўникма ва нуқтаи назарларга эга бўлган аъзоларни жалб қилиш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси роли жамоанинг ривожланишига тўсқинлик қилиши мумкин?",
                        "options": ["Мураббийлик", "Назоратчилик ва микробошқарув", "Фасилитаторлик"],
                        "correct": "Назоратчилик ва микробошқарув"
                    },
                    {
                        "text": "Лидерликда стрессни бошқаришнинг аҳамияти нимада?",
                        "options": ["Стресс ишлашга ёрдам беради", "Лидернинг ўзи ва жамоасининг самарадорлигини сақлаш учун", "Стрессни эътиборсиз қолдириш керак"],
                        "correct": "Лидернинг ўзи ва жамоасининг самарадорлигини сақлаш учун"
                    },
                    {
                        "text": "'Лидерлар китоби'да муваффақиятни қандай ўлчаш кераклиги таъкидланади?",
                        "options": ["Фақат молиявий кўрсаткичлар орқали", "Жамоанинг ўсиши, ривожланиши ва мақсадга эришиши орқали", "Фақат лидернинг шахсий ютуқлари орқали"],
                        "correct": "Жамоанинг ўсиши, ривожланиши ва мақсадга эришиши орқали"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида ижобий муҳит яратиши мумкин?",
                        "options": ["Доимо танқид қилиш орқали", "Ҳурмат, ҳамкорлик ва очиқ мулоқотни таъминлаш орқали", "Рақобатни кучайтириш орқали"],
                        "correct": "Ҳурмат, ҳамкорлик ва очиқ мулоқотни таъминлаш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси муносабати жамоада соғлом муносабатларни шакллантиради?",
                        "options": ["Бефарқлик", "Эътиборлилик ва ғамхўрлик", "Совуққонлик"],
                        "correct": "Эътиборлилик ва ғамхўрлик"
                    },
                    {
                        "text": "Лидерликда давомлилик (consistency) нинг аҳамияти нимада?",
                        "options": ["Давомлиликнинг аҳамияти йўқ", "Жамоада барқарорлик ва ишончни таъминлаш учун", "Ҳар доим ўзгариб туриш керак"],
                        "correct": "Жамоада барқарорлик ва ишончни таъминлаш учун"
                    },
                    {
                        "text": "'Лидерлар китоби'да ахлоқий лидерликнинг ўрни қандай белгиланади?",
                        "options": ["Ахлоқнинг аҳамияти иккинчи даражали", "Лидернинг ишончи ва обрўсининг асоси", "Фақат қонунларга риоя қилиш кифоя"],
                        "correct": "Лидернинг ишончи ва обрўсининг асоси"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасини ривожлантириши мумкин?",
                        "options": ["Фақат топшириқлар бериш орқали", "Ўқитиш, менторлик қилиш ва ўсиш имкониятларини яратиш орқали", "Ривожланишга эътибор бермаслик орқали"],
                        "correct": "Ўқитиш, менторлик қилиш ва ўсиш имкониятларини яратиш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси хислати жамоанинг муваффақиятига ҳисса қўшади?",
                        "options": ["Эгоизм", "Камтарлик ва хизмат қилишга тайёрлик", "Шов-шувлилик"],
                        "correct": "Камтарлик ва хизмат қилишга тайёрлик"
                    },
                    {
                        "text": "Лидерликда масъулиятни бўлишиш (shared responsibility) нинг аҳамияти нимада?",
                        "options": ["Фақат лидер жавобгар бўлиши керак", "Жамоа аъзоларининг иштирокини ошириш ва натижа учун биргаликда жавобгар бўлиш", "Масъулиятни бўлишиш иш самарадорлигини пасайтиради"],
                        "correct": "Жамоа аъзоларининг иштирокини ошириш ва натижа учун биргаликда жавобгар бўлиш"
                    },
                    {
                        "text": "'Лидерлар китоби'да танқидни қабул қилиш қандай тавсия этилади?",
                        "options": ["Танқидга эътибор бермаслик керак", "Танқидни ўсиш учун имконият сифатида қабул қилиш керак", "Танқид қилувчиларга қарши чиқиш керак"],
                        "correct": "Танқидни ўсиш учун имконият сифатида қабул қилиш керак"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида янги ғояларни қўллаб-қувватлаши мумкин?",
                        "options": ["Барча янги ғояларни рад этиш орқали", "Очиқ муҳокама қилиш ва тажриба ўтказиш учун шароит яратиш орқали", "Фақат ўзининг ғояларини қўллаб-қувватлаш орқали"],
                        "correct": "Очиқ муҳокама қилиш ва тажриба ўтказиш учун шароит яратиш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси муносабати жамоада инновацияларни ривожлантиради?",
                        "options": ["Қатъий назорат", "Эркинлик ва ташаббусни қўллаб-қувватлаш", "Қоидаларга қатъий риоя қилиш"],
                        "correct": "Эркинлик ва ташаббусни қўллаб-қувватлаш"
                    },
                    {
                        "text": "Лидерликда ривожланишнинг асосий омили нима?",
                        "options": ["Юқори лавозим эгаллаш", "Доимий ўрганиш ва ўз устида ишлаш", "Фақат тажрибага таяниш"],
                        "correct": "Доимий ўрганиш ва ўз устида ишлаш"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоани руҳлантиради?",
                        "options": ["Ваъдаларни бажармаслик", "Шахсий намуна бўлиш", "Фақат танқид қилиш"],
                        "correct": "Шахсий намуна бўлиш"
                    },
                    {
                        "text": "Лидерликда самарали режалаштиришнинг аҳамияти нимада?",
                        "options": ["Режанинг аҳамияти йўқ", "Мақсадларга эришишда йўналиш ва тартибни таъминлаш", "Фақат спонтан ҳаракат қилиш"],
                        "correct": "Мақсадларга эришишда йўналиш ва тартибни таъминлаш"
                    },
                    {
                        "text": "Китобда лидернинг қайси қобилияти муҳим деб айтилади?",
                        "options": ["Фақат гапириш", "Актив тинглаш", "Ҳиссий интеллектнинг паст даражаси"],
                        "correct": "Актив тинглаш"
                    },
                    {
                        "text": "Лидерликда муаммоларни ҳал қилишга ёндашув қандай бўлиши керак?",
                        "options": ["Муаммоларни эътиборсиз қолдириш", "Тизимли ва инновацион ёндашув", "Фақат анъанавий усуллардан фойдаланиш"],
                        "correct": "Тизимли ва инновацион ёндашув"
                    },
                    {
                        "text": "Лидерликнинг асосий вазифаси нима?",
                        "options": ["Мақсадга эришишда жамоани бирлаштириш ва йўналтириш", "Ходимларни қатъий назорат қилиш", "Шахсий фойдани кўзлаш"],
                        "correct": "Мақсадга эришишда жамоани бирлаштириш ва йўналтириш"
                    },
                    {
                        "text": "Китобда таъкидланган лидерлик фазилати:",
                        "options": ["Мағрурлик", "Масъулият", "Қатъиятсизлик"],
                        "correct": "Масъулият"
                    },
                    {
                        "text": "Самарали коммуникациянинг лидерликдаги аҳамияти:",
                        "options": ["Мулоқотнинг аҳамияти йўқ", "Ғояларни аниқ етказиш ва жамоа иштирокини таъминлаш", "Фақат расмий хабар алмашиш"],
                        "correct": "Ғояларни аниқ етказиш ва жамоа иштирокини таъминлаш"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида ишонч муҳитини яратади?",
                        "options": ["Доимо ўзига бўйсундириш орқали", "Шаффофлик, адолатлилик ва ваъдаларга амал қилиш орқали", "Кам хато қилишга интилиш орқали"],
                        "correct": "Шаффофлик, адолатлилик ва ваъдаларга амал қилиш орқали"
                    },
                    {
                        "text": "Китобда қайси лидерлик услуби тавсия этилади?",
                        "options": ["Автократик", "Трансформацион (ўзгарувчан)", "Лайссез-фер"],
                        "correct": "Трансформацион (ўзгарувчан)"
                    },
                    {
                        "text": "Лидернинг қарор қабул қилишдаги асосий тамойили:",
                        "options": ["Фақат ўз манфаатларига асосланиш", "Маълумотларга таяниш ва оқибатларини баҳолаш", "Ҳиссий қарорлар қабул қилиш"],
                        "correct": "Маълумотларга таяниш ва оқибатларини баҳолаш"
                    },
                    {
                        "text": "Нима учун лидер ўз жамоасига ваколат бериши керак?",
                        "options": ["Ишдан қочиш учун", "Жамоа аъзоларининг салоҳиятини ошириш ва ривожлантириш учун", "Назоратни камайтириш учун"],
                        "correct": "Жамоа аъзоларининг салоҳиятини ошириш ва ривожлантириш учун"
                    },
                    {
                        "text": "Лидерликда ҳиссий интеллектнинг ўрни қандай?",
                        "options": ["Аҳамиятсиз", "Ўз ҳис-туйғуларини ва бошқаларнинг ҳис-туйғуларини англаш ва бошқариш", "Фақат мантиқий фикрлаш муҳим"],
                        "correct": "Ўз ҳис-туйғуларини ва бошқаларнинг ҳис-туйғуларини англаш ва бошқариш"
                    },
                    {
                        "text": "Китобда лидернинг шахсий ўсиши қандай таъкидланади?",
                        "options": ["Бир марталик жараён", "Доимий ва узлуксиз жараён", "Лидерга тааллуқли эмас"],
                        "correct": "Доимий ва узлуксиз жараён"
                    },
                    {
                        "text": "Муаммоларни ҳал қилишда лидернинг ёндашуви:",
                        "options": ["Муаммоларни инкор этиш", "Муаммоларга дуч келиб, уларни ҳал қилишга конструктив ёндашиш", "Муаммоларни бошқаларга юклаш"],
                        "correct": "Муаммоларга дуч келиб, уларни ҳал қилишга конструктив ёндашиш"
                    },
                    {
                        "text": "Лидерликда фикр-мулоҳаза (feedback) нинг асосий мақсади:",
                        "options": ["Ходимларни танқид қилиш", "Ривожланиш учун имконият яратиш", "Ҳисобот бериш"],
                        "correct": "Ривожланиш учун имконият яратиш"
                    },
                    {
                        "text": "Нима учун лидер жамоада ўзаро ҳурмат муҳитини яратиши керак?",
                        "options": ["Фақат расмиятчилик учун", "Самарали ҳамкорлик ва ижобий муносабатлар учун", "Лидернинг обрўсини ошириш учун"],
                        "correct": "Самарали ҳамкорлик ва ижобий муносабатлар учун"
                    },
                    {
                        "text": "Китобда лидернинг хатоларга муносабати қандай бўлиши керак?",
                        "options": ["Хатоларни яшириш", "Хатолардан сабоқ чиқариш ва уларни ривожланиш имконияти сифатида кўриш", "Хатолар учун бошқаларни айблаш"],
                        "correct": "Хатолардан сабоқ чиқариш ва уларни ривожланиш имконияти сифатида кўриш"
                    },
                    {
                        "text": "Лидерликда креативликнинг аҳамияти нимада?",
                        "options": ["Креативликнинг аҳамияти йўқ", "Янги ғоялар ва ечимларни топиш учун", "Фақат санъаткорлар учун зарур"],
                        "correct": "Янги ғоялар ва ечимларни топиш учун"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида масъулият ҳиссини оширади?",
                        "options": ["Ҳар бир қадамни назорат қилиш орқали", "Ваколат бериш ва натижалар учун биргаликда жавобгарликни шакллантириш орқали", "Жазолаш орқали"],
                        "correct": "Ваколат бериш ва натижалар учун биргаликда жавобгарликни шакллантириш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоада руҳ тушишига олиб келиши мумкин?",
                        "options": ["Мақсадларни аниқ белгилаш", "Ноаниқлик ва доимий фикр ўзгартириш", "Муваффақиятларни тақдирлаш"],
                        "correct": "Ноаниқлик ва доимий фикр ўзгартириш"
                    },
                    {
                        "text": "Лидерликда ўз-ўзини бошқаришнинг аҳамияти нимада?",
                        "options": ["Ўз-ўзини бошқаришнинг аҳамияти йўқ", "Шахсий самарадорлик ва стрессга қарши курашиш учун", "Фақат бошқаларни бошқариш муҳим"],
                        "correct": "Шахсий самарадорлик ва стрессга қарши курашиш учун"
                    },
                    {
                        "text": "Нима учун лидер доимо ўрганиши керак?",
                        "options": ["Фақат диплом олиш учун", "Замон билан ҳамнафас бўлиш ва янги билимларни эгаллаш учун", "Ўрганишнинг кераги йўқ"],
                        "correct": "Замон билан ҳамнафас бўлиш ва янги билимларни эгаллаш учун"
                    },
                    {
                        "text": "Китобда қайси лидерлик сифати энг муҳимлардан бири деб ҳисобланади?",
                        "options": ["Жуда қаттиққўллик", "Самимият", "Ходимларга ишончсизлик"],
                        "correct": "Самимият"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида юқори натижаларга эришади?",
                        "options": ["Фақат буйруқ бериш орқали", "Ҳар бир аъзонинг салоҳиятидан самарали фойдаланиш ва уларни рағбатлантириш орқали", "Рақобатни кучайтириш орқали"],
                        "correct": "Ҳар бир аъзонинг салоҳиятидан самарали фойдаланиш ва уларни рағбатлантириш орқали"
                    },
                    {
                        "text": "Лидерликда стратегик фикрлашнинг аҳамияти нимада?",
                        "options": ["Фақат кундалик муаммоларни ҳал қилиш", "Узоқ муддатли мақсадларни белгилаш ва уларга эришиш йўлларини топиш", "Стратегик фикрлаш вақтни олади"],
                        "correct": "Узоқ муддатли мақсадларни белгилаш ва уларга эришиш йўлларини топиш"
                    },
                    {
                        "text": "Китобда лидернинг қайси хислати ишончсизликка олиб келади?",
                        "options": ["Адолатлилик", "Қайсарлик ва ўзгалар фикрини инобатга олмаслик", "Очиқлик"],
                        "correct": "Қайсарлик ва ўзгалар фикрини инобатга олмаслик"
                    },
                    {
                        "text": "Лидерликда жамоавий руҳни шакллантиришнинг аҳамияти нимада?",
                        "options": ["Жамоавий руҳнинг аҳамияти йўқ", "Бирдамлик, ҳамкорлик ва ўзаро ёрдамни кучайтириш учун", "Фақат шахсий ютуқлар муҳим"],
                        "correct": "Бирдамлик, ҳамкорлик ва ўзаро ёрдамни кучайтириш учун"
                    },
                    {
                        "text": "Лидер қандай қилиб ўз жамоасида мотивацияни оширади?",
                        "options": ["Фақат моддий рағбатлантириш билан", "Мақсадларнинг аҳамиятини тушунтириш, муваффақиятларни тан олиш ва ривожланиш имкониятини бериш орқали", "Доимий назорат билан"],
                        "correct": "Мақсадларнинг аҳамиятини тушунтириш, муваффақиятларни тан олиш ва ривожланиш имкониятини бериш орқали"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоада қўрқув муҳитини яратади?",
                        "options": ["Рағбатлантириш", "Доимий танқид ва жазолаш", "Ҳамкорлик"],
                        "correct": "Доимий танқид ва жазолаш"
                    },
                    {
                        "text": "Лидерликда стрессни бошқаришга ёндашув қандай бўлиши керак?",
                        "options": ["Стрессни эътиборсиз қолдириш", "Стрессни камайтириш усулларини қўллаш ва жамоага ёрдам бериш", "Стрессни жамоага юклаш"],
                        "correct": "Стрессни камайтириш усулларини қўллаш ва жамоага ёрдам бериш"
                    },
                    {
                        "text": "Нима учун лидер доимо ижобий бўлиши керак?",
                        "options": ["Фақат яхши кайфият учун", "Жамоани руҳлантириш ва қийинчиликларни енгишга ундаш учун", "Ҳеч қандай сабаб йўқ"],
                        "correct": "Жамоани руҳлантириш ва қийинчиликларни енгишга ундаш учун"
                    },
                    {
                        "text": "Китобда лидернинг қайси сифати жамоада ишончсизликка олиб келади?",
                        "options": ["Ростгўйлик", "Ёлғончилик ва иккиюзламачилик", "Очиқлик"],
                        "correct": "Ёлғончилик ва иккиюзламачилик"
                    },
                    {
                        "text": "Лидерликда муаммоларни олдиндан кўра билишнинг аҳамияти нимада?",
                        "options": ["Муаммолар олдиндан кўринмайди", "Келажакдаги рискларни олдиндан баҳолаш ва уларга тайёрланиш", "Фақат муаммолар юзага келганда ҳал қилиш"],
                        "correct": "Келажакдаги рискларни олдиндан баҳолаш ва уларга тайёрланиш"
                    },
                    {
                        "text": "Китобда лидернинг қайси роли муҳим эмас?",
                        "options": ["Кўрсатувчи", "Назоратчи", "Илҳомлантирувчи"],
                        "correct": "Назоратчи"
                    },
                    {
                        "text": "Лидерликда конфликтларни ҳал қилишнинг энг самарали йўли:",
                        "options": ["Конфликтларни инкор этиш", "Очиқ мулоқот ва ўзаро келишувга эришиш", "Конфликтни кучайтириш"],
                        "correct": "Очиқ мулоқот ва ўзаро келишувга эришиш"
                    },
                    {
                        "text": "Нима учун лидер ўз жамоасига ишончи комил бўлиши керак?",
                        "options": ["Фақат обрў учун", "Жамоа аъзоларининг потенциалини рўёбга чиқаришга ёрдам бериш учун", "Ишни бошқаларга ташлаш учун"],
                        "correct": "Жамоа аъзоларининг потенциалини рўёбга чиқаришга ёрдам бериш учун"
                    },
                    {
                        "text": "Китобда қайси ёндашув лидерликни ривожлантиришга ёрдам беради?",
                        "options": ["Муаммоларни фақат ўзи ҳал қилиш", "Бошқалардан ўрганиш ва тажриба алмашиш", "Янги ғояларни қабул қилмаслик"],
                        "correct": "Бошқалардан ўрганиш ва тажриба алмашиш"
                    },
                    {
                        "text": "Лидернинг мақсадга эришишдаги асосий сифати:",
                        "options": ["Сабрсизлик", "Қатъият ва тиришқоқлик", "Эгоистлик"],
                        "correct": "Қатъият ва тиришқоқлик"
                    },
                    {
                        "text": "Китобда лидерликнинг қайси жиҳатига урғу берилади?",
                        "options": ["Фақат шахсий ютуқлар", "Жамоавий ютуқлар ва ўзаро ҳамкорлик", "Рақобатбардошлик"],
                        "correct": "Жамоавий ютуқлар ва ўзаро ҳамкорлик"
                    },
                    {
                        "text": "Лидерликда ўсиш ва ривожланишнинг асосий тамойили:",
                        "options": ["Бир марталик ўрганиш", "Доимий ўсиш ва ўз-ўзини такомиллаштириш", "Фақат иш тажрибаси"],
                        "correct": "Доимий ўсиш ва ўз-ўзини такомиллаштириш"
                    },
                    {
                        "text": "Нима учун лидер ўз жамоасида ижобий муҳит яратиши керак?",
                        "options": ["Расмиятчилик учун", "Юқори иш самарадорлиги ва ходимларнинг қониқиши учун", "Лидернинг кайфияти учун"],
                        "correct": "Юқори иш самарадорлиги ва ходимларнинг қониқиши учун"
                    },
                    {
                        "text": "Китобда қайси лидерлик сифати жамоада намуна бўлади?",
                        "options": ["Эгоизм", "Масъулиятлилик", "Лоқайдлик"],
                        "correct": "Масъулиятлилик"
                    },
                    {
                        "text": "Лидерликда мақсадларга эришишнинг асосий йўли:",
                        "options": ["Фақат буйруқ бериш", "Аниқ мақсадлар қўйиш ва уларга эришиш учун жамоани бирлаштириш", "Мақсадларни ўзгартириб туриш"],
                        "correct": "Аниқ мақсадлар қўйиш ва уларга эришиш учун жамоани бирлаштириш"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоада ишончни мустаҳкамлайди?",
                        "options": ["Ёлғон ваъдалар бериш", "Ваъдаларга амал қилиш ва очиқ мулоқот", "Фақат ўз фикрида туриш"],
                        "correct": "Ваъдаларга амал қилиш ва очиқ мулоқот"
                    },
                    {
                        "text": "Лидерликда ўзгаришларга мослашишнинг аҳамияти нимада?",
                        "options": ["Ўзгаришлардан қочиш керак", "Янги шароитларга мослашиш ва ривожланишда давом этиш", "Консерватив бўлиш"],
                        "correct": "Янги шароитларга мослашиш ва ривожланишда давом этиш"
                    },
                    {
                        "text": "Китобда лидернинг қайси хислати жамоага ижобий таъсир кўрсатади?",
                        "options": ["Танқидчилик", "Руҳлантириш", "Лоқайдлик"],
                        "correct": "Руҳлантириш"
                    },
                    {
                        "text": "Лидерликда интуициянинг роли:",
                        "options": ["Муҳим эмас", "Баъзида мантиқдан кўра тезроқ қарор қабул қилишда ёрдам беради", "Фақат таваккал қилиш"],
                        "correct": "Баъзида мантиқдан кўра тезроқ қарор қабул қилишда ёрдам беради"
                    },
                    {
                        "text": "Нима учун лидер ўз хатоларини тан олиши керак?",
                        "options": ["Жамоага ожизлигини кўрсатиш учун", "Жамоада очиқлик ва ишонч муҳитини яратиш учун", "Узр сўраш учун"],
                        "correct": "Жамоада очиқлик ва ишонч муҳитини яратиш учун"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоавий ижодийликни оширади?",
                        "options": ["Барча ғояларни рад этиш", "Ташаббусни қўллаб-қувватлаш ва янги ғояларга очиқ бўлиш", "Фақат ўз ғояларини мажбурлаш"],
                        "correct": "Ташаббусни қўллаб-қувватлаш ва янги ғояларга очиқ бўлиш"
                    },
                    {
                        "text": "Лидерликда ҳалолликнинг аҳамияти нимада?",
                        "options": ["Аҳамиятсиз", "Ишонч ва обрўнинг асоси", "Фақат шахсий сифат"],
                        "correct": "Ишонч ва обрўнинг асоси"
                    },
                    {
                        "text": "Китобда лидернинг қайси сифати жамоада муваффақиятга эришишга ёрдам беради?",
                        "options": ["Ёлғончилик", "Адолатлилик", "Ўзгаларга ишончсизлик"],
                        "correct": "Адолатлилик"
                    },
                    {
                        "text": "Лидерликда ўз-ўзини баҳолашнинг аҳамияти нимада?",
                        "options": ["Ўз-ўзини баҳолашнинг аҳамияти йўқ", "Кучли ва заиф томонларини аниқлаш ва ривожланиш учун", "Ўзини танқид қилиш учун"],
                        "correct": "Кучли ва заиф томонларини аниқлаш ва ривожланиш учун"
                    },
                    {
                        "text": "Китобда лидернинг қайси ҳаракати жамоада бирдамликни кучайтиради?",
                        "options": ["Бўлинишга ундаш", "Умумий мақсадлар атрофида бирлаштириш", "Рақобатни кучайтириш"],
                        "correct": "Умумий мақсадлар атрофида бирлаштириш"
                    },
                    {
                        "text": "Лидерликда бошқаларга хизмат қилиш тамойилининг аҳамияти нимада?",
                        "options": ["Лидернинг мақсади эмас", "Жамоа ва атрофдагилар манфаати учун ишлаш", "Фақат ўзига фойда келтириш"],
                        "correct": "Жамоа ва атрофдагилар манфаати учун ишлаш"
                    },
                  {
                      "text": "Лидерликнинг асосий моҳияти нимада?",
                      "options": ["Бошқаларга таъсир кўрсатиш ва уларни мақсадга эришишга ундаш", "Фақат расмий лавозимда бўлиш", "Молиявий ресурсларни бошқариш"],
                      "correct": "Бошқаларга таъсир кўрсатиш ва уларни мақсадга эришишга ундаш"
                  },
                  {
                      "text": "Китобда таъкидланган лидернинг муҳим сифати:",
                      "options": ["Шахсий мақсадлар устуворлиги", "Масъулият", "Бефарқлик"],
                      "correct": "Масъулият"
                  },
                  {
                      "text": "Самарали жамоа қуришда лидернинг роли қандай?",
                      "options": ["Ҳар бир ишни ўзи бажариш", "Аъзоларнинг кучли томонларини бирлаштириш ва уларни рағбатлантириш", "Фақат заиф томонларни танқид қилиш"],
                      "correct": "Аъзоларнинг кучли томонларини бирлаштириш ва уларни рағбатлантириш"
                  },
                  {
                      "text": "Лидерликда ишончнинг пойдевори нима?",
                      "options": ["Бойлик", "Ҳалоллик ва самимият", "Мансаб"],
                      "correct": "Ҳалоллик ва самимият"
                  },
                  {
                      "text": "Китобда қайси лидерлик услуби жамоа ривожига хизмат қилади?",
                      "options": ["Назоратга асосланган", "Илҳомлантирувчи ва ривожлантирувчи", "Суст"],
                      "correct": "Илҳомлантирувчи ва ривожлантирувчи"
                  },
                  {
                      "text": "Лидернинг қарор қабул қилишда эътибор бериши керак бўлган жиҳат:",
                      "options": ["Маълумотларни таҳлил қилиш ва оқибатларни баҳолаш", "Фақат шахсий хоҳиш-истаклар", "Тезда қарор чиқариш"],
                      "correct": "Маълумотларни таҳлил қилиш ва оқибатларни баҳолаш"
                  },
                  {
                      "text": "Ваколат бериш (делегатсия) нинг асосий фойдаси:",
                      "options": ["Лидернинг ишини камайтириш", "Ходимларнинг малакасини ошириш ва ташаббускорлигини рағбатлантириш", "Иш сифатини пасайтириш"],
                      "correct": "Ходимларнинг малакасини ошириш ва ташаббускорлигини рағбатлантириш"
                  },
                  {
                      "text": "Ҳиссий интеллект лидерликда нима учун муҳим?",
                      "options": ["Ҳиссий интеллексиз ҳам бошқариш мумкин", "Ўз ва ўзгалар ҳис-туйғуларини тушуниш ва бошқариш", "Фақат шахсий муносабатлар учун"],
                      "correct": "Ўз ва ўзгалар ҳис-туйғуларини тушуниш ва бошқариш"
                  },
                  {
                      "text": "Лидернинг доимий ўсишига нима туртки бўлади?",
                      "options": ["Танқид", "Доимий ўрганиш ва ўз устида ишлаш", "Бошқаларнинг муваффақияти"],
                      "correct": "Доимий ўрганиш ва ўз устида ишлаш"
                  },
                  {
                      "text": "Муаммоларни ҳал қилишда лидернинг самарали ёндашуви:",
                      "options": ["Муаммодан қочиш", "Масалага тизимли ёндашиш ва янги ечимлар излаш", "Эски усулларни қўллаш"],
                      "correct": "Масалага тизимли ёндашиш ва янги ечимлар излаш"
                  },
                  {
                      "text": "Фикр-мулоҳаза (feedback) нинг лидерликдаги асосий мақсади:",
                      "options": ["Хатоларни кўрсатиш", "Шахсий ва жамоавий ўсишни таъминлаш", "Низоларни келтириб чиқариш"],
                      "correct": "Шахсий ва жамоавий ўсишни таъминлаш"
                  },
                  {
                      "text": "Жамоада ўзаро ҳурмат муҳитининг аҳамияти:",
                      "options": ["Расмиятчилик учун", "Ишчанлик муҳитини яхшилаш ва ҳамкорликни кучайтириш", "Лидернинг обрўсини ошириш"],
                      "correct": "Ишчанлик муҳитини яхшилаш ва ҳамкорликни кучайтириш"
                  },
                  {
                      "text": "Лидернинг хатоларга муносабати қандай бўлиши керак?",
                      "options": ["Хатолардан сабоқ чиқариш ва уларни такрорламасликка интилиш", "Хатоларни яшириш", "Хатолар учун бошқаларни айблаш"],
                      "correct": "Хатолардан сабоқ чиқариш ва уларни такрорламасликка интилиш"
                  },
                  {
                      "text": "Креативлик лидерликда нима учун муҳим?",
                      "options": ["Янги ғояларнинг кераги йўқ", "Инновацион ечимларни топиш ва ташкилотни ривожлантириш", "Фақат санъат соҳасида зарур"],
                      "correct": "Инновацион ечимларни топиш ва ташкилотни ривожлантириш"
                  },
                  {
                      "text": "Жамоада масъулият ҳиссини оширишда лидернинг роли:",
                      "options": ["Барча масъулиятни ўз зиммасига олиш", "Ваколат бериш ва жавобгарликни тақсимлаш", "Назоратни кучайтириш"],
                      "correct": "Ваколат бериш ва жавобгарликни тақсимлаш"
                  },
                  {
                      "text": "Лидернинг ноаниқлик ва доимий фикр ўзгартиришининг оқибати:",
                      "options": ["Жамоанинг тез мослашуви", "Жамоада ишончсизлик ва руҳ тушиши", "Иш самарадорлигининг ошиши"],
                      "correct": "Жамоада ишончсизлик ва руҳ тушиши"
                  },
                  {
                      "text": "Ўз-ўзини бошқариш лидерликда нима учун зарур?",
                      "options": ["Шахсий самарадорлик ва стрессга қарши курашиш учун", "Бошқаларни бошқариш учун", "Ҳеч қандай аҳамияти йўқ"],
                      "correct": "Шахсий самарадорлик ва стрессга қарши курашиш учун"
                  },
                  {
                      "text": "Лидернинг доимий ўрганишининг асосий сабаби:",
                      "options": ["Диплом олиш", "Замонавий талабларга мослашиш ва ривожланиш", "Ўрганишнинг кераги йўқ"],
                      "correct": "Замонавий талабларга мослашиш ва ривожланиш"
                  },
                  {
                      "text": "Самимият лидерликда нима учун муҳим?",
                      "options": ["Фақат шахсий муносабатлар учун", "Жамоада ишонч ва очиқлик муҳитини яратиш учун", "Расмийятчилик учун"],
                      "correct": "Жамоада ишонч ва очиқлик муҳитини яратиш учун"
                  },
                  {
                      "text": "Юқори натижаларга эришишда лидернинг асосий вазифаси:",
                      "options": ["Фақат буйруқ бериш", "Жамоанинг потенциалидан тўлиқ фойдаланиш ва уларни рағбатлантириш", "Рақобатни кучайтириш"],
                      "correct": "Жамоанинг потенциалидан тўлиқ фойдаланиш ва уларни рағбатлантириш"
                  },
                  {
                      "text": "Стратегик фикрлаш лидерликда нима учун керак?",
                      "options": ["Фақат кундалик муаммолар учун", "Ташкилотни узоқ муддатли ривожлантириш учун", "Стратегик фикрлаш вақтни олади"],
                      "correct": "Ташкилотни узоқ муддатли ривожлантириш учун"
                  },
                  {
                      "text": "Қайсарлик ва ўзгалар фикрини инобатга олмасликнинг оқибати:",
                      "options": ["Тез қарор қабул қилиш", "Жамоада ишончсизлик ва норозилик", "Лидернинг қатъиятлилиги"],
                      "correct": "Жамоада ишончсизлик ва норозилик"
                  },
                  {
                      "text": "Жамоавий руҳнинг аҳамияти нимада?",
                      "options": ["Аҳамиятсиз", "Бирдамлик ва ўзаро ёрдамни кучайтириш", "Фақат шахсий ют"],
                      "correct": "Бирдамлик ва ўзаро ёрдамни кучайтириш"
                  },
                  {
                      "text": "Мотивацияни оширишда лидернинг роли:",
                      "options": ["Фақат моддий рағбатлантириш", "Мақсадларнинг аҳамиятини тушунтириш ва ривожланиш имкониятини бериш", "Доимий назорат"],
                      "correct": "Мақсадларнинг аҳамиятини тушунтириш ва ривожланиш имкониятини бериш"
                  },
                  {
                      "text": "Доимий танқид ва жазолашнинг оқибати:",
                      "options": ["Иш самарадорлигининг ошиши", "Жамоада қўрқув муҳити ва ишдан қочиш", "Интизомнинг яхшиланиши"],
                      "correct": "Жамоада қўрқув муҳити ва ишдан қочиш"
                  },
                  {
                      "text": "Стрессни бошқариш лидерликда нима учун муҳим?",
                      "options": ["Стресс ишлашга ёрдам беради", "Лидернинг ўзи ва жамоасининг самарадорлигини сақлаш учун", "Стрессни жамоага юклаш"],
                      "correct": "Лидернинг ўзи ва жамоасининг самарадорлигини сақлаш учун"
                  },
                  {
                      "text": "Лидернинг ижобий бўлиши нима учун керак?",
                      "options": ["Фақат яхши кайфият учун", "Жамоани руҳлантириш ва қийинчиликларни енгишга ундаш", "Ҳеч қандай сабаб йўқ"],
                      "correct": "Жамоани руҳлантириш ва қийинчиликларни енгишга ундаш"
                  },
                  {
                      "text": "Ёлғончилик ва иккиюзламачиликнинг оқибати:",
                      "options": ["Жамоада ишончнинг ошиши", "Жамоада ишончсизлик ва муносабатларнинг ёмонлашиши", "Лидернинг обрўсининг ошиши"],
                      "correct": "Жамоада ишончсизлик ва муносабатларнинг ёмонлашиши"
                  },
                  {
                      "text": "Муаммоларни олдиндан кўра билишнинг аҳамияти:",
                      "options": ["Муаммолар олдиндан кўринмайди", "Келажакдаги рискларни олдиндан баҳолаш ва уларга тайёрланиш", "Фақат муаммолар юзага келганда ҳал қилиш"],
                      "correct": "Келажакдаги рискларни олдиндан баҳолаш ва уларга тайёрланиш"
                  },
                  {
                      "text": "Лидернинг асосий роли:",
                      "options": ["Назоратчи", "Илҳомлантирувчи", "Ҳисобот берувчи"],
                      "correct": "Илҳомлантирувчи"
                  },
                  {
                      "text": "Конфликтларни ҳал қилишда энг самарали йўл:",
                      "options": ["Конфликтни инкор этмоқ", "Очиқ мулоқот ва ўзаро келишувга эришиш", "Конфликтни кучайтириш"],
                      "correct": "Очиқ мулоқот ва ўзаро келишувга эришиш"
                  },
                  {
                      "text": "Лидернинг ўз жамоасига ишончи нима учун муҳим?",
                      "options": ["Фақат обрў учун", "Жамоа аъзоларининг потенциалини рўёбга чиқаришга ёрдам бериш учун", "Ишни бошқаларга ташлаш учун"],
                      "correct": "Жамоа аъзоларининг потенциалини рўёбга чиқаришга ёрдам бериш учун"
                  },
                  {
                      "text": "Лидерликни ривожлантиришда қайси ёндашув самарали?",
                      "options": ["Муаммоларни фақат ўзи ҳал қилиш", "Бошқалардан ўрганиш ва тажриба алмашиш", "Янги ғояларни қабул қилмаслик"],
                      "correct": "Бошқалардан ўрганиш ва тажриба алмашиш"
                  },
                  {
                      "text": "Мақсадга эришишда лидернинг асосий сифати:",
                      "options": ["Сабрсизлик", "Қатъият ва тиришқоқлик", "Эгоистлик"],
                      "correct": "Қатъият ва тиришқоқлик"
                  },
                  {
                      "text": "Лидерликнинг қайси жиҳатига урғу берилади?",
                      "options": ["Фақат шахсий ютуқлар", "Жамоавий ютуқлар ва ўзаро ҳамкорлик", "Рақобатбардошлик"],
                      "correct": "Жамоавий ютуқлар ва ўзаро ҳамкорлик"
                  },
                  {
                      "text": "Ўсиш ва ривожланишнинг асосий тамойили:",
                      "options": ["Бир марталик ўрганиш", "Доимий ўсиш ва ўз-ўзини такомиллаштириш", "Фақат иш тажрибаси"],
                      "correct": "Доимий ўсиш ва ўз-ўзини такомиллаштириш"
                  },
                  {
                      "text": "Жамоада ижобий муҳит яратиш нима учун керак?",
                      "options": ["Расмиятчилик учун", "Юқори иш самарадорлиги ва ходимларнинг қониқиши учун", "Лидернинг кайфияти учун"],
                      "correct": "Юқори иш самарадорлиги ва ходимларнинг қониқиши учун"
                  },
                  {
                      "text": "Китобда қайси лидерлик сифати жамоада намуна бўлади?",
                      "options": ["Эгоизм", "Масъулиятлилик", "Лоқайдлик"],
                      "correct": "Масъулиятлилик"
                  },
                  {
                      "text": "Мақсадларга эришишнинг асосий йўли:",
                      "options": ["Фақат буйруқ бериш", "Аниқ мақсадлар қўйиш ва уларга эришиш учун жамоани бирлаштириш", "Мақсадларни ўзгартириб туриш"],
                      "correct": "Аниқ мақсадлар қўйиш ва уларга эришиш учун жамоани бирлаштириш"
                  },
                  {
                      "text": "Лидернинг ваъдаларга амал қилишининг оқибати:",
                      "options": ["Жамоада ишончсизлик", "Жамоада ишончни мустаҳкамлаш", "Фақат ўз фикрида туриш"],
                      "correct": "Жамоада ишончни мустаҳкамлаш"
                  },
                  {
                      "text": "Ўзгаришларга мослашишнинг аҳамияти нимада?",
                      "options": ["Ўзгаришлардан қочиш керак", "Янги шароитларга мослашиш ва ривожланишда давом этиш", "Консерватив бўлиш"],
                      "correct": "Янги шароитларга мослашиш ва ривожланишда давом этиш"
                  },
                  {
                      "text": "Лидернинг қайси хислати жамоага ижобий таъсир кўрсатади?",
                      "options": ["Танқидчилик", "Руҳлантириш", "Лоқайдлик"],
                      "correct": "Руҳлантириш"
                  },
                  {
                      "text": "Лидерликда интуициянинг роли:",
                      "options": ["Муҳим эмас", "Баъзида мантиқдан кўра тезроқ қарор қабул қилишда ёрдам беради", "Фақат таваккал қилиш"],
                      "correct": "Баъзида мантиқдан кўра тезроқ қарор қабул қилишда ёрдам беради"
                  },
                  {
                      "text": "Лидернинг ўз хатоларини тан олиши нима учун муҳим?",
                      "options": ["Жамоага ожизлигини кўрсатиш учун", "Жамоада очиқлик ва ишонч муҳитини яратиш учун", "Узр сўраш учун"],
                      "correct": "Жамоада очиқлик ва ишонч муҳитини яратиш учун"
                  },
                  {
                      "text": "Жамоавий ижодийликни оширишда лидернинг ҳаракати:",
                      "options": ["Барча ғояларни рад этиш", "Ташаббусни қўллаб-қувватлаш ва янги ғояларга очиқ бўлиш", "Фақат ўз ғояларини мажбурлаш"],
                      "correct": "Ташаббусни қўллаб-қувватлаш ва янги ғояларга очиқ бўлиш"
                  },
                  {
                      "text": "Ҳалоллик лидерликда нима учун муҳим?",
                      "options": ["Аҳамиятсиз", "Ишонч ва обрўнинг асоси", "Фақат шахсий сифат"],
                      "correct": "Ишонч ва обрўнинг асоси"
                  },
                  {
                      "text": "Лидернинг қайси сифати жамоада муваффақиятга эришишга ёрдам беради?",
                      "options": ["Ёлғончилик", "Адолатлилик", "Ўзгаларга ишончсизлик"],
                      "correct": "Адолатлилик"
                  },
                  {
                      "text": "Ўз-ўзини баҳолашнинг аҳамияти нимада?",
                      "options": ["Ўзини баҳолашнинг аҳамияти йўқ", "Кучли ва заиф томонларини аниқлаш ва ривожланиш учун", "Ўзини танқид қилиш учун"],
                      "correct": "Кучли ва заиф томонларини аниқлаш ва ривожланиш учун"
                  },
                  {
                      "text": "Жамоада бирдамликни кучайтиришда лидернинг роли:",
                      "options": ["Бўлинишга ундаш", "Умумий мақсадлар атрофида бирлаштириш", "Рақобатни кучайтириш"],
                      "correct": "Умумий мақсадлар атрофида бирлаштириш"
                  },
                  {
                      "text": "Бошқаларга хизмат қилиш тамойилининг аҳамияти:",
                      "options": ["Лидернинг мақсади эмас", "Жамоа ва атрофдагилар манфаати учун ишлаш", "Фақат ўзига фойда келтириш"],
                      "correct": "Жамоа ва атрофдагилар манфаати учун ишлаш"
                  }
                ]

def seed_questions():
    try:
        with Session() as db:
            if db.query(Question).count() == 0:
                for q in sample_questions:
                    if not all(key in q for key in ["text", "options", "correct"]):
                        logger.error(f"Invalid question format: {q}")
                        continue
                    if not isinstance(q["options"], list) or len(q["options"]) != 3:
                        logger.error(f"Invalid options for question: {q['text']}")
                        continue
                    if q["correct"] not in q["options"]:
                        logger.error(f"Correct option not in options for question: {q['text']}")
                        continue
                    db.add(Question(
                        text=q["text"],
                        options=q["options"],
                        correct_option=q["correct"]
                    ))
                db.commit()
                logger.info("✅ Вопросы успешно добавлены в базу данных.")
            else:
                logger.info("Вопросы уже существуют в базе данных.")
    except Exception as e:
        logger.error(f"Ошибка при загрузке вопросов в базу данных: {e}")



# FSM состояния
class TestStates(StatesGroup):
    waiting_name = State()
    in_test = State()

# Оценка длительности прохождения теста
def estimate_duration_seconds(answered: int) -> int:
    fast = int(answered * 0.7)
    slow = answered - fast
    return fast * random.randint(10, 25) + slow * 40

@router.message(CommandStart())
async def start(message: Message, state: FSMContext):
    now = datetime.now()
    if now < TEST_START or now > TEST_END:
        await message.answer("Тест доступен только с 1 июня 00:00 до 23:59:59.")
        return

    with Session() as db:
        user = db.query(User).filter_by(telegram_id=message.from_user.id).first()
        if user and user.completed:
            try:
                await message.answer(f"Вы уже прошли тест с результатом {user.score}/40.")
            except TelegramForbiddenError:
                logger.warning(f"User {message.from_user.id} blocked the bot")
                return
            return

    try:
        await message.answer("Введите ваше ФИО для участия в тесте:")
        await state.set_state(TestStates.waiting_name)
    except TelegramForbiddenError:
        logger.warning(f"User {message.from_user.id} blocked the bot")
        return



# Получение ФИО
@router.message(TestStates.waiting_name)
async def get_name(message: Message, state: FSMContext):
    full_name = message.text.strip()
    telegram_id = message.from_user.id

    if not full_name or len(full_name) < 5:
        try:
            await message.answer("Пожалуйста, введите корректное ФИО (не менее 5 символов).")
        except TelegramForbiddenError:
            logger.warning(f"User {telegram_id} blocked the bot")
            await state.clear()
            return
        return

    with Session() as db:
        user = db.query(User).filter_by(telegram_id=telegram_id).first()
        if not user:
            user = User(telegram_id=telegram_id, full_name=full_name)
            db.add(user)
            db.commit()

    with Session() as db:
        questions = db.query(Question).all()
        if len(questions) < 40:
            try:
                await message.answer("Недостаточно вопросов в базе данных для проведения теста.")
            except TelegramForbiddenError:
                logger.warning(f"User {telegram_id} blocked the bot")
                await state.clear()
                return
            return
        random.shuffle(questions)

    await state.update_data(
        index=0,
        questions=[q.id for q in questions[:40]],
        score=0,
        answered=False,
        start_time=datetime.utcnow().timestamp()
    )
    await state.set_state(TestStates.in_test)
    try:
        await send_next_question(message.chat.id, state)
    except TelegramForbiddenError:
        logger.warning(f"User {telegram_id} blocked the bot")
        await state.clear()
        return

# Отправка следующего вопроса
async def send_next_question(chat_id: int, state: FSMContext):
    try:
        user_data = await state.get_data()
        questions = user_data.get("questions", [])
        current_question_idx = user_data.get("current_question", 0)
        
        if current_question_idx >= len(questions):
            score = user_data.get("score", 0)
            with Session() as session:
                user = session.query(User).filter_by(telegram_id=chat_id).first()
                if user:
                    user.score = score
                    user.completed = True
                    session.commit()
            await bot.send_message(
                chat_id,
                f"🌟 Тест завершен! Ваш результат: {score}/{len(questions)}. Спасибо за участие! 🚀"
            )
            await state.clear()
            return

        question = questions[current_question_idx]
        keyboard = InlineKeyboardBuilder()
        for idx in range(len(question.options)):
            # Используем индекс вместо текста варианта
            callback_data = f"answer_{question.id}_{idx}"
            if len(callback_data.encode('utf-8')) > 64:
                logger.error(f"Callback_data слишком длинное: {callback_data}")
                await bot.send_message(chat_id, "Ошибка при формировании вопроса. Свяжитесь с администратором.")
                return
            keyboard.add({"text": question.options[idx], "callback_data": callback_data})
        keyboard.adjust(1)

        await bot.send_message(
            chat_id,
            f"Вопрос {current_question_idx + 1}/{len(questions)}:\n{question.text}",
            reply_markup=keyboard.build()
        )
        await state.update_data(current_question=current_question_idx + 1)
        logger.info(f"Отправлен вопрос {current_question_idx + 1} для chat_id {chat_id}")
    except TelegramForbiddenError:
        logger.error(f"Пользователь {chat_id} заблокировал бота.")
    except Exception as e:
        logger.error(f"Ошибка в send_next_question: {e}")
        await bot.send_message(chat_id, "Произошла ошибка. Попробуйте снова.")

# Ответ на вопрос
@router.callback_query(TestStates.in_test)
async def handle_answer(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    index = data["index"]
    question_ids = data["questions"]
    q_id = data["current_question_id"]
    last_message_id = data.get("last_message_id")

    if last_message_id:
        try:
            await bot.delete_message(chat_id=callback.message.chat.id, message_id=last_message_id)
        except TelegramForbiddenError:
            logger.warning(f"User {callback.message.chat.id} blocked the bot")
            await state.clear()
            return

    with Session() as db:
        question = db.query(Question).get(q_id)

    await state.update_data(answered=True)
    if callback.data == question.correct_option:
        await state.update_data(score=data["score"] + 1)
        try:
            await callback.answer("Правильно!")
        except TelegramForbiddenError:
            logger.warning(f"User {callback.message.chat.id} blocked the bot")
            await state.clear()
            return
    else:
        try:
            await callback.answer("Неправильно.")
        except TelegramForbiddenError:
            logger.warning(f"User {callback.message.chat.id} blocked the bot")
            await state.clear()
            return

    if index + 1 < len(question_ids):
        await state.update_data(index=index + 1, answered=False)
        try:
            await send_next_question(callback.message.chat.id, state)
        except TelegramForbiddenError:
            logger.warning(f"User {callback.message.chat.id} blocked the bot")
            await state.clear()
            return
    else:
        try:
            await finish_test(callback.message.chat.id, state)
        except TelegramForbiddenError:
            logger.warning(f"User {callback.message.chat.id} blocked the bot")
            await state.clear()
            return

@router.message(Command("top10"))
async def top10(message: Message):
    try:
        with Session() as db:
            users = (
                db.query(User)
                .filter(User.completed == True)
                .order_by(User.score.desc(), User.estimated_duration.asc())
                .limit(10)
                .all()
            )

        if not users:
            await message.answer("Пока никто не прошёл тест.")
            return

        text = "<b>🏆 Топ 10 участников:</b>\n"
        for i, user in enumerate(users, 1):
            mins = user.estimated_duration // 60 if user.estimated_duration else "—"
            text += f"{i}. {user.full_name} — {user.score} баллов, {mins} мин\n"

        await message.answer(text)
    except Exception as e:
        logger.error(f"Error in /top10: {e}")
        await message.answer("Ошибка при получении результатов.")

# Запуск
if __name__ == "__main__":
    logger.info("Bot is running...")
    asyncio.run(dp.start_polling(bot))
